<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>人生修复指南 | Life Repair Guide</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #fcfaf7; color: #1c1917; }
    .serif { font-family: 'Noto Serif SC', serif; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #fcfaf7; }
    ::-webkit-scrollbar-thumb { background: #e7e5e4; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #d6d3d1; }
    @media print { .no-print { display: none !important; } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { AlertTriangle, ArrowDown, CheckCircle2, Copy, Printer, ShieldAlert, Zap, Target, Sparkles, Loader2, Compass } = lucideReact;

    const QUOTES = [
      { cn: "你想拥有的生活，建立在你不敢放手的废墟之上。", en: "The life you want is built on the ruins of the life you are afraid to let go of." },
      { cn: "如果你不知道自己想要什么，看看你讨厌什么。反向愿景通常比正向目标更具动力。", en: "If you don't know what you want, look at what you hate. Anti-vision is often more motivating than positive goals." },
      { cn: "身份驱动行为。除非你改变‘我是谁’，否则你的‘做什么’永远只是痛苦的博弈。", en: "Identity drives behavior. Until you change who you are, what you do will always be a struggle." },
      { cn: "平庸是一种缓慢的死亡。意识到这一点并不残忍，无视它才残忍。", en: "Mediocrity is a slow death. Realizing this isn't cruel; ignoring it is." }
    ];

    const INITIAL_STATE = {
      date: new Date().toISOString().split('T')[0],
      commitment: false,
      antiVision: { health: '', relationships: '', finance: '', work: '', selfTalk: '', summary: '', rootCause: '' },
      newIdentity: { naturalActions: '', iAmStatements: '', drivers: '', trueTodoList: '' },
      planning: { skills: Array(4).fill({ name: '', level: 0, unlockCondition: '' }), mechanismsDetail: '', milestones: '' },
      completedPhases: [],
      aiOptimalPath: ''
    };

    const App = () => {
      const [state, setState] = useState(() => {
        const saved = localStorage.getItem('life-reset-data');
        return saved ? JSON.parse(saved) : INITIAL_STATE;
      });
      const [isExpanding, setIsExpanding] = useState(null);

      useEffect(() => localStorage.setItem('life-reset-data', JSON.stringify(state)), [state]);

      const updateState = (path, value) => {
        const keys = path.split('.');
        setState(prev => {
          const newState = JSON.parse(JSON.stringify(prev));
          let current = newState;
          for (let i = 0; i < keys.length - 1; i++) current = current[keys[i]];
          current[keys[keys.length - 1]] = value;
          return newState;
        });
      };

      const togglePhaseCompletion = (phaseId) => {
        setState(prev => ({
          ...prev,
          completedPhases: prev.completedPhases.includes(phaseId)
            ? prev.completedPhases.filter(id => id !== phaseId)
            : [...prev.completedPhases, phaseId]
        }));
      };

      const scrollToNext = (id) => document.getElementById(id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });

      const handleAIExpand = (fieldPath, fieldTitle, fieldDescription, currentValue) => {
        if (!currentValue.trim()) {
          alert("请先输入一些您的初步想法，AI 才能为您扩写。");
          return;
        }
        const prompt = `你是一位深度心理咨询专家和 Dan Koe 哲学的践行者。
当前模块：${fieldTitle}
模块说明：${fieldDescription}
用户输入的初步想法：${currentValue}

请基于 Dan Koe 的理念（反向愿景、身份驱动、系统化执行），对用户的输入进行扩写和深化。
要求：语言深刻、严肃、有冲击力，直接输出扩写后的文本。`;

        navigator.clipboard.writeText(prompt);
        alert("提示词已复制到剪贴板！去Claude/GPT/豆包生成后粘贴回来");
        setIsExpanding(fieldPath);
        setTimeout(() => setIsExpanding(null), 3000);
      };

      const exportAsText = () => {
        const content = `人生修复指南摘要 - ${state.date}\n\n反向愿景总结：${state.antiVision.summary}\n新身份宣言：${state.newIdentity.iAmStatements}\n真正想做：${state.newIdentity.trueTodoList}\n技能树：${state.planning.skills.map(s => s.name).filter(Boolean).join(', ')}\n里程碑：${state.planning.milestones}`;
        navigator.clipboard.writeText(content);
        alert('已复制全部内容');
      };

      const exportImage = () => {
        html2canvas(document.body, { scale: 2 }).then(canvas => {
          const a = document.createElement('a');
          a.href = canvas.toDataURL('image/png');
          a.download = '人生修复指南.png';
          a.click();
        });
      };

      const ReflectionBox = ({ title, description, value, onChange, onExpand, isExpanding, icon, minimal = false }) => (
        <div className={`space-y-4 ${minimal ? '' : 'group'} relative`}>
          <div className="flex justify-between items-start">
            <div className="space-y-1">
              {!minimal && <div className="flex items-center gap-2">{icon}<h3 className="serif font-bold text-lg text-stone-800">{title}</h3></div>}
              {minimal && <h4 className="text-xs font-bold text-stone-400 uppercase tracking-widest">{title}</h4>}
            </div>
            {onExpand && (
              <button onClick={onExpand} disabled={isExpanding} className="flex items-center gap-1.5 px-3 py-1.5 bg-stone-100 text-stone-500 rounded-lg text-[10px] font-bold uppercase tracking-wider hover:bg-amber-50 hover:text-amber-700 transition-all disabled:opacity-50">
                {isExpanding ? <Loader2 className="animate-spin" size={12} /> : <Sparkles size={12} />}
                {isExpanding ? "扩写中..." : "AI扩写"}
              </button>
            )}
          </div>
          <p className="text-stone-400 text-xs leading-relaxed">{description}</p>
          <textarea value={value} onChange={e => onChange(e.target.value)} placeholder="开始你的深度自省..." className="w-full bg-white border border-stone-200 rounded-2xl p-6 text-stone-800 focus:outline-none focus:ring-4 focus:ring-stone-50 min-h-[160px] transition-all placeholder:text-stone-200 leading-relaxed shadow-sm resize-none" />
        </div>
      );

      const NavItem = ({ label, onClick, completed }) => (
        <button onClick={onClick} className={`flex items-center gap-2 text-[10px] font-bold uppercase tracking-[0.15em] transition-all ${completed ? 'text-emerald-600' : 'text-stone-400 hover:text-stone-900'}`}>
          {completed && <CheckCircle2 size={10} />}
          {label}
        </button>
      );

      return (
        <div className="min-h-screen text-stone-900 bg-[#fcfaf7] px-4 py-12 md:px-0 transition-colors duration-500">
          <div className="max-w-3xl mx-auto space-y-32 mb-32">
            {/* Intro */}
            <section id="intro" className="min-h-[80vh] flex flex-col justify-center items-center text-center space-y-8">
              <div className="space-y-4">
                <h1 className="text-4xl md:text-6xl font-bold tracking-tighter serif text-stone-900">人生修复指南</h1>
                <p className="text-stone-400 text-lg md:text-xl font-medium tracking-widest uppercase">Life Repair Guide</p>
              </div>
              <div className="bg-white border border-stone-200 p-8 rounded-3xl max-w-2xl text-left space-y-6 shadow-sm">
                <div className="flex items-start gap-4 text-amber-600">
                  <AlertTriangle size={24} />
                  <p className="text-sm font-medium leading-relaxed">警告：这不是一次轻松的心理测试。你即将面对的是对旧自我的解构。这需要你预留一整天（8-10小时）的绝对专注。</p>
                </div>
                <div className="space-y-4 pt-4">
                  {QUOTES.map((q, idx) => (
                    <div key={idx} className="space-y-1">
                      <p className="text-stone-700 serif text-lg leading-relaxed">“{q.cn}”</p>
                      <p className="text-stone-400 italic text-xs">{q.en}</p>
                    </div>
                  ))}
                </div>
              </div>
              <div className="flex flex-col items-center gap-6 pt-8 w-full max-w-sm">
                <input type="date" value={state.date} onChange={e => updateState('date', e.target.value)} className="bg-white border border-stone-200 rounded-xl p-3 text-stone-900 w-full" />
                <label className="flex items-center gap-3 cursor-pointer group">
                  <input type="checkbox" checked={state.commitment} onChange={e => updateState('commitment', e.target.checked)} className="w-5 h-5 rounded border-stone-300 bg-white" />
                  <span className="text-stone-500">我承诺今天花一整天深度自省</span>
                </label>
                <button disabled={!state.commitment} onClick={() => scrollToNext('phase-1')} className={`w-full py-4 rounded-full font-bold text-lg transition-all ${state.commitment ? 'bg-stone-900 text-stone-50 hover:bg-stone-800' : 'bg-stone-200 text-stone-400'}`}>
                  开始修复 <ArrowDown className="inline ml-2" size={18} />
                </button>
              </div>
            </section>

            {/* Phase 1 */}
            <section id="phase-1" className={`space-y-12 transition-all duration-700 ${state.completedPhases.includes('p1') ? 'opacity-40 grayscale-[0.5]' : 'opacity-100'}`}>
              <header className="space-y-4">
                <div className="flex items-center gap-3 text-stone-400 uppercase tracking-widest text-xs font-bold">
                  <span className="bg-stone-100 px-2 py-1 rounded">阶段 01</span>
                  <span>上午重点：挖掘痛苦根源</span>
                </div>
                <h2 className="text-3xl md:text-5xl font-bold tracking-tight serif text-stone-900">反向
